{% extends 'admin/admin_base.html' %}
{% load static %}

{% block title %}Booking Details - {{ booking.booking_id.hex|slice:":8"|upper }} - Global Cool-Light E.A LTD{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #374151;
        min-width: 150px;
    }
    
    .detail-value {
        color: #1f2937;
        flex: 1;
        text-align: right;
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-new { background: #fef3c7; color: #92400e; }
    .status-confirmed { background: #dbeafe; color: #1e40af; }
    .status-in_progress { background: #fde68a; color: #92400e; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .status-rescheduled { background: #e0e7ff; color: #3730a3; }
    
    .priority-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .priority-low { background: #f3f4f6; color: #374151; }
    .priority-normal { background: #dbeafe; color: #1e40af; }
    .priority-high { background: #fed7aa; color: #ea580c; }
    .priority-urgent { background: #fecaca; color: #dc2626; }
    
    .action-section {
        background: #f8fafc;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .booking-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -2rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #004AAD;
    }
    
    .timeline-item::after {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 1.25rem;
        width: 2px;
        height: calc(100% - 0.75rem);
        background: #e5e7eb;
    }
    
    .timeline-item:last-child::after {
        display: none;
    }
    
    .timeline-content {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb;
    }
    
    .form-section h4 {
        color: #374151;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<!-- Sidebar Start -->
<div class="sidebar pe-4 pb-3">
    <nav class="navbar bg-light navbar-light">
        <a href="{% url 'users:admin_dashboard' %}" class="navbar-brand mx-4 mb-3">
            <h3 class="text-primary"><i class="fas fa-snowflake me-2"></i>Global Cool-Light</h3>
        </a>
        <div class="d-flex align-items-center ms-4 mb-4">
            <div class="position-relative">
                <img class="rounded-circle" src="{% static 'admin-img/user.jpg' %}" alt="" style="width: 40px; height: 40px;">
                <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
            </div>
            <div class="ms-3">
                <h6 class="mb-0">{{ user.get_full_name|default:user.email }}</h6>
                <span>Admin</span>
            </div>
        </div>
        <div class="navbar-nav w-100">
            <a href="{% url 'users:admin_dashboard' %}" class="nav-item nav-link">
                <i class="fa fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <div class="nav-item dropdown">
                <a href="#" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown">
                    <i class="fas fa-calendar-check me-2"></i>Bookings
                </a>
                <div class="dropdown-menu bg-transparent border-0">
                    <a href="{% url 'users:admin_bookings_list' %}" class="dropdown-item">All Bookings</a>
                    <a href="{% url 'users:admin_bookings_list' %}?status=new" class="dropdown-item">Pending Bookings</a>
                    <a href="{% url 'users:admin_bookings_list' %}?status=completed" class="dropdown-item">Completed Bookings</a>
                </div>
            </div>
            <div class="nav-item dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-tools me-2"></i>Services
                </a>
                <div class="dropdown-menu bg-transparent border-0">
                    <a href="#" class="dropdown-item">All Services</a>
                    <a href="#" class="dropdown-item">Add Service</a>
                    <a href="#" class="dropdown-item">Service Categories</a>
                </div>
            </div>
            <a href="#" class="nav-item nav-link">
                <i class="fas fa-briefcase me-2"></i>Portfolio
            </a>
            <a href="#" class="nav-item nav-link">
                <i class="fas fa-file-invoice-dollar me-2"></i>Quotations
            </a>
            <a href="#" class="nav-item nav-link">
                <i class="fas fa-users me-2"></i>Customers
            </a>
        </div>
    </nav>
</div>
<!-- Sidebar End -->

<!-- Content Start -->
<div class="content">
    <!-- Navbar Start -->
    <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
        <a href="{% url 'users:admin_dashboard' %}" class="navbar-brand d-flex d-lg-none me-4">
            <h2 class="text-primary mb-0"><i class="fas fa-snowflake"></i></h2>
        </a>
        <a href="#" class="sidebar-toggler flex-shrink-0">
            <i class="fa fa-bars"></i>
        </a>
        <div class="navbar-nav align-items-center ms-auto">
            <div class="nav-item dropdown">
                <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                    <img class="rounded-circle me-lg-2" src="{% static 'admin-img/user.jpg' %}" alt="" style="width: 40px; height: 40px;">
                    <span class="d-none d-lg-inline-flex">{{ user.get_full_name|default:user.email }}</span>
                </a>
                <div class="dropdown-menu dropdown-menu-end bg-light border-0 rounded-0 rounded-bottom m-0">
                    <a href="#" class="dropdown-item">My Profile</a>
                    <a href="#" class="dropdown-item">Settings</a>
                    <a href="{% url 'users:admin_logout' %}" class="dropdown-item">Log Out</a>
                </div>
            </div>
        </div>
    </nav>
    <!-- Navbar End -->

    <!-- Main Content -->
    <div class="container-fluid pt-4 px-4">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">Booking Details</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'users:admin_dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'users:admin_bookings_list' %}">Bookings</a></li>
                        <li class="breadcrumb-item active">{{ booking.booking_id.hex|slice:":8"|upper }}</li>
                    </ol>
                </nav>
            </div>
            <div>
                <a href="{% url 'users:admin_bookings_list' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Bookings
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Booking Information -->
            <div class="col-lg-8">
                <div class="detail-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4><i class="fas fa-info-circle me-2"></i>Booking Information</h4>
                        <div>
                            <span class="status-badge status-{{ booking.status }}">{{ booking.get_status_display }}</span>
                            <span class="priority-badge priority-{{ booking.priority }} ms-2">{{ booking.get_priority_display }}</span>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Booking ID:</span>
                        <span class="detail-value">
                            <code>{{ booking.booking_id.hex|slice:":8"|upper }}</code>
                        </span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Service:</span>
                        <span class="detail-value">{{ booking.service.name }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Customer:</span>
                        <span class="detail-value">{{ booking.contact_name }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">
                            <a href="mailto:{{ booking.contact_email }}">{{ booking.contact_email }}</a>
                        </span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">
                            <a href="tel:{{ booking.contact_phone }}">{{ booking.contact_phone }}</a>
                        </span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Preferred Date:</span>
                        <span class="detail-value">{{ booking.preferred_date|date:"F d, Y" }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Preferred Time:</span>
                        <span class="detail-value">{{ booking.get_preferred_time_slot_display }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value">{{ booking.location_address }}</span>
                    </div>
                    
                    {% if booking.assigned_technician %}
                    <div class="detail-row">
                        <span class="detail-label">Assigned Technician:</span>
                        <span class="detail-value">{{ booking.assigned_technician.get_full_name|default:booking.assigned_technician.username }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="detail-row">
                        <span class="detail-label">Source:</span>
                        <span class="detail-value">{{ booking.get_source_display }}</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">{{ booking.created_at|date:"F d, Y g:i A" }}</span>
                    </div>
                    
                    {% if booking.message %}
                    <div class="detail-row">
                        <span class="detail-label">Message:</span>
                        <span class="detail-value">{{ booking.message }}</span>
                    </div>
                    {% endif %}
                    
                    {% if booking.estimated_cost or booking.actual_cost %}
                    <div class="detail-row">
                        <span class="detail-label">Cost Information:</span>
                        <span class="detail-value">
                            {% if booking.estimated_cost %}
                                Estimated: KSh {{ booking.estimated_cost|floatformat:0 }}
                            {% endif %}
                            {% if booking.actual_cost %}
                                {% if booking.estimated_cost %} | {% endif %}
                                Actual: KSh {{ booking.actual_cost|floatformat:0 }}
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                </div>

                <!-- Admin Notes -->
                {% if booking.admin_notes %}
                <div class="detail-card">
                    <h4><i class="fas fa-sticky-note me-2"></i>Admin Notes</h4>
                    <div class="bg-light p-3 rounded">
                        {{ booking.admin_notes|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Management Actions -->
            <div class="col-lg-4">
                <!-- Status Management -->
                <div class="form-section">
                    <h4><i class="fas fa-tasks me-2"></i>Status Management</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_status">
                        <div class="mb-3">
                            <label class="form-label">Update Status</label>
                            <select name="status" class="form-select">
                                <option value="{{ booking.status }}" selected>{{ booking.get_status_display }} (Current)</option>
                                {% for value, label in status_choices %}
                                    {% if value != booking.status %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Status transitions are validated to ensure proper workflow.
                                </small>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Update Status</button>
                    </form>
                </div>

                <!-- Technician Assignment -->
                <div class="form-section">
                    <h4><i class="fas fa-user-tie me-2"></i>Assign Technician</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="assign_technician">
                        <div class="mb-3">
                            <label class="form-label">Select Technician</label>
                            <select name="technician_id" class="form-select">
                                <option value="">Unassigned</option>
                                {% for technician in technicians %}
                                <option value="{{ technician.id }}" {% if booking.assigned_technician.id == technician.id %}selected{% endif %}>
                                    {{ technician.get_full_name|default:technician.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Assign Technician</button>
                    </form>
                </div>

                <!-- Cost Management -->
                <div class="form-section">
                    <h4><i class="fas fa-dollar-sign me-2"></i>Cost Management</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_cost">
                        <div class="mb-3">
                            <label class="form-label">Estimated Cost (KSh)</label>
                            <input type="number" name="estimated_cost" class="form-control" 
                                   value="{{ booking.estimated_cost|default:'' }}" step="0.01" min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Actual Cost (KSh)</label>
                            <input type="number" name="actual_cost" class="form-control" 
                                   value="{{ booking.actual_cost|default:'' }}" step="0.01" min="0">
                        </div>
                        <button type="submit" class="btn btn-info w-100">Update Cost</button>
                    </form>
                </div>

                <!-- Admin Notes -->
                <div class="form-section">
                    <h4><i class="fas fa-comment me-2"></i>Admin Notes</h4>
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_notes">
                        <div class="mb-3">
                            <textarea name="admin_notes" class="form-control" rows="4" 
                                      placeholder="Add internal notes about this booking...">{{ booking.admin_notes }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">Update Notes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Start -->
    <div class="container-fluid pt-4 px-4">
        <div class="bg-light rounded-top p-4">
            <div class="row">
                <div class="col-12 col-sm-6 text-center text-sm-start">
                    &copy; <a href="{% url 'core:home' %}">Global Cool-Light E.A LTD</a>, All Right Reserved.
                </div>
                <div class="col-12 col-sm-6 text-center text-sm-end">
                    Designed By <a href="#">Global Cool-Light Team</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer End -->
</div>
<!-- Content End -->
{% endblock %}
